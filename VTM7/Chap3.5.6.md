### 5.3.6    Joint coding of chroma residuals

VVC Draft 6 supports a mode where the chroma residuals are coded jointly. The usage (activation) of a joint chroma coding mode is indicated by a TU-level flag *tu_joint_cbcr_residual_flag* and the selected mode is implicitly indicated by the chroma CBFs. The flag *tu_joint_cbcr_residual_flag* is present if either or both chroma CBFs for a TU are equal to 1. In the PPS and slice header, chroma QP offset values are signalled for the joint chroma residual coding mode to differentiate from the usual chroma QP offset values signalled for regular chroma residual coding mode. These chroma QP offset values are used to derive the chroma QP values for those blocks coded using the joint chroma residual coding mode. When a corresponding joint chroma coding mode (modes 2 in Table 3-12) is active in a TU, this chroma QP offset is added to the applied luma-derived chroma QP during quantization and decoding of that TU. For the other modes (modes 1 and 3 in Table 3-12), the chroma QPs are derived in the same way as for conventional Cb or Cr blocks. The reconstruction process of the chroma residuals (resCb and resCr) from the transmitted transform blocks is depicted in Table 3-12. When this mode is activated, one single joint chroma residual block (resJointC[x][y] in Table 3-12) is signalled, and residual block for Cb (resCb) and residual block for Cr (resCr) are derived considering information such as tu_cbf_cb, tu_cbf_cr, and CSign, which is a sign value specified in the slice header. 

At the encoder side, the joint chroma components are derived as explained in the following. Depending on the mode (listed in the tables above), resJointC{1,2} are generated by the encoder as follows:

·     If mode is equal to 2 (single residual with reconstruction Cb = C, Cr = CSign * C), the joint residual is determined according to

​      resJointC[ x ][ y ] = ( resCb[ x ][ y ] + CSign * resCr[ x ][ y ] ) / 2.

·     Otherwise, if mode is equal to 1 (single residual with reconstruction Cb = C, Cr = (CSign * C) / 2), the joint residual is determined according to

​      resJointC[ x ][ y ] = ( 4 * resCb[ x ][ y ] + 2 * CSign * resCr[ x ][ y ] ) / 5.

·     Otherwise (mode is equal to 3, i. e., single residual, reconstruction Cr = C, Cb = (CSign * C) / 2), the joint residual is determined according to

​      resJointC[ x ][ y ] = ( 4 * resCr[ x ][ y ] + 2 * CSign * resCb[ x ][ y ] ) / 5.

Table 3-12 Reconstruction of chroma residuals. The value CSign is a sign value (+1 or –1), which is specified in the slice header, resJointC[ ][ ] is the transmitted residual.

| tu_cbf_cb | tu_cbf_cr | reconstruction  of Cb and Cr residuals                       | mode |
| --------- | --------- | ------------------------------------------------------------ | ---- |
| 1         | 0         | resCb[ x ][ y ]  = resJointC[ x ][ y ]    resCr[ x ][ y ] = ( CSign *  resJointC[ x ][ y ] ) >> 1 | 1    |
| 1         | 1         | resCb[ x ][ y ]  = resJointC[ x ][ y ]    resCr[ x ][ y ] = CSign *  resJointC[ x ][ y ] | 2    |
| 0         | 1         | resCb[ x ][ y ]  = ( CSign * resJointC[ x ][ y ] ) >> 1   resCr[ x ][ y ] = resJointC[ x ][ y ] | 3    |

The three joint chroma coding modes described above are only supported in I slices. In P and B slices, only mode 2 is supported. Hence, in P and B slices, the syntax element *tu_joint_cbcr_residual_flag* is only present if both chroma cbfs are 1. Note that transform depth is removed in the context modeling of tu_cbf_luma and tu_cbf_cb.