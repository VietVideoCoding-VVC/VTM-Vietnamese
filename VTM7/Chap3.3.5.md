### 1.1.1    Intra Sub-Partitions (ISP)

The Intra Sub-Partitions (ISP) tool divides luma intra-predicted blocks vertically or horizontally into 2 or 4 sub-partitions depending on the block size. For example, minimum block size for ISP is 4x8 (or 8x4). If block size is greater than 4x8 (or 8x4) then the corresponding block is divided by 4 sub-partitions. It has been noted that the $M\times128$ (with $M\leq64$ ) and $128\times N$ (with $N\leq 64$ ) ISP blocks could generate a potential issue with the  $64\times64$ VDPU. For example, an $M\times 128$  CU in the single tree case has an $M\times 128$ luma TB and two corresponding  $\frac{M}{2} \times 64$ chroma TBs. If the CU uses ISP, then the luma TB will be divided into four $M\times 32$ TBs (only the horizontal split is possible), each of them smaller than a $64\times 64$ block. However, in the current design of ISP chroma blocks are not divided. Therefore, both chroma components will have a size greater than a $32 \times 32$ block. Analogously, a similar situation could be created with a $128\times N$ CU using ISP. Hence, these two cases are an issue for the $64 \times 64$ decoder pipeline. For this reason, the CU sizes that can use ISP is restricted to a maximum of $64 \times 64$. Figure 19 shows examples of the two possibilities. All sub-partitions fulfill the condition of having at least 16 samples.  

In ISP, the dependence of $1\times N/2\times N$ subblock prediction on the reconstructed values of previously decoded $1\times N/2 \times N$ subblocks of the coding block is not allowed so that the minimum width of prediction for subblocks becomes four samples. For example, an $8\times N (N > 4)$ coding block that is coded using ISP with vertical split is split into two prediction regions each of size $4\times N$ and four transforms of size $2\times N$. Also, a $4\times N$ coding block that is coded using ISP with vertical split is predicted using the full 4xN block; four transform each of 1xN is used. Although the transform sizes of $1\times N$ and $2\times N$ are allowed, it is asserted that the transform of these blocks in 4xN regions can be performed in parallel. For example, when a $4 \times N$ prediction region contains four $1\times N$ transforms, there is no transform in the horizontal direction; the transform in the vertical direction can be performed as a single $4\times N$ transform in the vertical direction. Similarly, when a $4 \times N$ prediction region contains two $2\times N$ transform blocks, the transform operation of the two $2 \times N$ blocks in each direction (horizontal and vertical) can be conducted in parallel. Thus, there is no delay added in processing these smaller blocks than processing $4 \times 4$ regular-coded intra blocks.

![Fig19-A](C:\Users\Thuong\Documents\GitHub\VTM7-Vn\VTM7\imgs\Fig19-A.png)
   

a) Examples of sub-partitions for 4x8 and 8x4 CUs

  ![Fig19-B](C:\Users\Thuong\Documents\GitHub\VTM7-Vn\VTM7\imgs\Fig19-B.png)

b) Examples of sub-partitions for CUs other than $4\times 8$, $8\times 4$ and $4\times 4$

**Figure** **19** ‑ **Sub-partition depending on the block size**

**Table** **3-6** **– Entropy coding coefficient group size**

| **Block Size**                         | **Coefficient group Size** |
| -------------------------------------- | -------------------------- |
| $1\times N, N \geq 16$                 | $1\times 16$               |
| $N\times 1, N \geq 16$                 | $16\times 1$               |
| $2\times N, N \geq 8$                  | $2\times 8$                |
| $N\times 2, N \geq 8$                  | $8 \times 2$               |
| All  other possible $M \times N$ cases | $4 \times 4$               |

For each sub-partition, reconstructed samples are obtained by adding the residual signal to the prediction signal. Here, a residual signal is generated by the processes such as entropy decoding, inverse quantization and inverse transform. Therefore, the reconstructed sample values of each sub-partition are available to generate the prediction of the next sub-partition, and each sub-partition is processed repeatedly. In addition, the first sub-partition to be processed is the one containing the top-left sample of the CU and then continuing downwards (horizontal split) or rightwards (vertical split). As a result, reference samples used to generate the sub-partitions prediction signals are only located at the left and above sides of the lines. All sub-partitions share the same intra mode. The followings are summary of interaction of ISP with other coding tools.

\-     Multiple Reference Line (MRL): if a block has an MRL index other than 0, then the ISP coding mode will be inferred to be 0 and therefore ISP mode information will not be sent to the decoder.

\-     Entropy coding coefficient group size: the sizes of the entropy coding subblocks have been modified so that they have 16 samples in all possible cases, as shown in Table 3‑6. Note that the new sizes only affect blocks produced by ISP in which one of the dimensions is less than 4 samples. In all other cases coefficient groups keep the $4\times 4$  dimensions.

\-    CBF coding: it is assumed to have at least one of the sub-partitions has a non-zero CBF. Hence, if   is the number of sub-partitions and the first $n-1$ sub-partitions have produced a zero CBF, then the CBF of the   $n$-th sub-partition is inferred to be 1. 

\-     MPM usage: the MPM flag will be inferred to be one in a block coded by ISP mode, and the MPM list is modified to exclude the DC mode and to prioritize horizontal intra modes for the ISP horizontal split and vertical intra modes for the vertical one.

\-     Transform size restriction: all ISP transforms with a length larger than 16 points uses the DCT-II.

\-     PDPC: when a CU uses the ISP coding mode, the PDPC filters will not be applied to the resulting sub-partitions.

\-     MTS flag: if a CU uses the ISP coding mode, the MTS CU flag will be set to 0 and it will not be sent to the decoder. Therefore, the encoder will not perform RD tests for the different available transforms for each resulting sub-partition. The transform choice for the ISP mode will instead be fixed and selected according the intra mode, the processing order and the block size utilized. Hence, no signalling is required. For example, let $t_H$ and $t_V$ be the horizontal and the vertical transforms selected respectively for the $w\times h$ sub-partition, where $w$ is the width and $h$ is the height. Then the transform is selected according to the following rules:

* If $w=1$ or $h=1$, then there is no horizontal or vertical transform respectively.

* If $w=2$ or $w>32$, $t_H$= DCT-II

* If $h=2$ or $h>32$, $t_V$= DCT-II

* Otherwise, the transform is selected as in Table 3‑7. 



Table 3‑7 – Transform selection depends on intra mode

| **Intra mode** $t_V$                    | $t_H$   | $t_V$   |
| --------------------------------------- | ------- | ------- |
| Planar  Ang. 31,32,34,36,37             | DST-VII | DST-VII |
| DC;  Ang. 33, 35                        | DCT-II  | DCT-II  |
| Ang. 2, 4, 6…28,30  Ang. 39,41,43…63,65 | DST-VII | DCT-II  |
| Ang. 3,5,7…27,29  Ang. 38,40,42…64,66   | DCT-II  | DST-VII |

In ISP mode, all 67 intra modes are allowed. PDPC is also applied if corresponding width and height is at least 4 samples long. In addition, the condition for intra interpolation filter selection doesn’t exist anymore, and Cubic (DCT-IF) filter is always applied for fractional position interpolation in ISP mode.